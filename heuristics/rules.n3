@prefix list: <http://www.w3.org/2000/10/swap/list#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix log: <http://www.w3.org/2000/10/swap/log#> .
@prefix dfg: <http://rdf.org/dfg#> .
@prefix : <http://example.org/> .

# - infer missing events after a known event up until next decision point OR end
# (data1.n3)
{ ( ?from ?to ) dfg:inferredEventFromKnownEvent ?known_e }
<= {
    ?known_e dfg:normative true ; dfg:discovered true .
    ( ?known_e () ) dfg:collectBranchLinks ?links .
    ( ?from ?to ) list:in ?links .
    _:t log:notIncludes { ?l dfg:from ?from ; dfg:to ?to ; dfg:source dfg:discovered }
} .

{ ( ?from ?cur ) dfg:collectBranchLinks ?links }
<= {
    ?l dfg:from ?from ; dfg:to ?to ; dfg:source dfg:normative .
    ?to a dfg:DecisionPoint .
    ( ?cur (( ?from ?to )) ) list:append ?links .
    # "collect1" log:trace ( ?to ?links ).
    true log:callWithCut true .
} .

{ ( ?from ?cur ) dfg:collectBranchLinks ?cur }
<= {
    ?l dfg:from ?from ; dfg:to dfg:nil ; dfg:source dfg:normative .
    # "collect2" log:trace ( ?to ?cur ) .
    true log:callWithCut true .
} .

{ ( ?from ?cur ) dfg:collectBranchLinks ?links }
<= {
    ?l dfg:from ?from ; dfg:to ?to ; dfg:source dfg:normative .
    ( ?cur (( ?from ?to )) ) list:append ?cur2 .
    # "collect3" log:trace ( ?to ?cur2 ) .
    ( ?to ?cur2 ) dfg:collectBranchLinks ?links .
} .



# - infer decisions based on their downstream events
# (data2.n3)
{ ?pt dfg:inferredDecisionFromFollowingEvent ?norm_d } 
<= {   
    ?pt a dfg:DecisionPoint ; dfg:normative true ; dfg:discovered true .

    # collect decisions in discovered model
    (?disc_d {
        ?disc_l dfg:from ?pt ; dfg:to ?disc_d ; dfg:source dfg:discovered .

    } ?disc_ds) log:collectAllIn _:t .
    # "inf - disc_ds" log:trace ?disc_ds .

    # for each "missing" decision, i.e., in normative but not discovered model
    ?norm_l dfg:from ?pt ; dfg:to ?norm_d ; dfg:source dfg:normative .
    ?norm_d list:notIn ?disc_ds .
    # "inf - norm_d" log:trace ?norm_d .

    # missing decision's choice branch includes a discovered decision
    ( ?disc_ds ?norm_d ) dfg:inChoiceBranch ?determ .

    # no other incoming edges for discovered decision in normative model
    ?determ dfg:determinant true .
} .

{ ( ?options ?cur ) dfg:inChoiceBranch ?cur }
<= {
    ?cur list:in ?options .
    # "choice - found" log:trace ?cur .
    true log:callWithCut true .
} .

{ ( ?options ?cur ) dfg:inChoiceBranch ?found }
<= {
    # "choice - searching" log:trace ?cur .
    ?l dfg:from ?cur ; dfg:to ?next ; dfg:source dfg:normative .
    ( ?options ?next ) dfg:inChoiceBranch ?found .
} .



# - infer decision points based on downstream decisions
{ ?pt dfg:inferredDecisionPointFromFollowingDecision ?d } 
<= {
    ?pt a dfg:DecisionPoint ; dfg:normative true ; dfg:discovered false .
    ?l dfg:from ?pt ; dfg:to ?d . 
    ?d dfg:discovered true .
    ?d dfg:determinant true .
} .


# helpers

{ ?m list:notIn ?lst } 
<= { (1 { ?m list:in ?lst } ()) log:collectAllIn _:t } .

{ ?e dfg:link ?l }
<= { ?l dfg:from ?e } .

{ ?e dfg:link ?l }
<= { ?l dfg:to ?e } .

# { ?e a dfg:Activity } <= { ?l dfg:from ?e } .
# { ?e a dfg:Activity } <= { ?l dfg:to ?e } .

{ ?e a dfg:DecisionPoint . } 
<= {
    ?l1 dfg:from ?e .
    ?l2 dfg:from ?e .
    ?l1 log:notEqualTo ?l2 .
} .

{ ?e dfg:normative true }
<= { ?e dfg:link ?l . ?l dfg:source dfg:normative } .

{ ?e dfg:discovered true }
<= { ?e dfg:link ?l . ?l dfg:source dfg:discovered } .

{ ?e dfg:normative false }
<= { _:t log:notIncludes { ?e dfg:link ?l . ?l dfg:source dfg:normative } } .

{ ?e dfg:discovered false }
<= { _:t log:notIncludes { ?e dfg:link ?l . ?l dfg:source dfg:discovered } } .

{ ( ?e ?src ) dfg:priors ?priors }
<= { 
    (?prior
        {
            ?l dfg:to ?e ; dfg:from ?prior ; dfg:source ?src
        }
    ?priors) log:collectAllIn _:t .
} .

# no other incoming edges for event in normative model
{ ?e dfg:determinant true }
<= { 
    ( ?e dfg:normative ) dfg:priors ?priors .
    # "determinant?" log:trace ( ?priors "=>" ?determ ) .
    ?priors list:length 1 .
 } .