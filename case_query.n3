@prefix log: <http://www.w3.org/2000/10/swap/log#> .
@prefix math: <http://www.w3.org/2000/10/swap/math#> .
@prefix list: <http://www.w3.org/2000/10/swap/list#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix tr: <http://rdf.org/trace#> .
@prefix p2: <http://ocel2.org/p2p#> .

{
    # ?case_obj_type log:equalTo p2:purchase_requisition .

    ?pr log:equalTo p2:purchase_requisition:0:pr_trigger_0 .
    ?pr log:skolem ?trace .

    ( ?results 
        { ?pr tr:pathObjectEvents ( ( p2:quotation p2:purchase_order p2:payment ) () ?results ) }
    ?all ) log:collectAllIn _:t .

    ?all!list:append list:unique ?all_unique .
    ?all_unique list:sortOn ?all_sorted .

    ?all_sorted list:iterate (?i ?event ) .
    ( ?i 1 ) math:sum ?j .
    ?all_sorted!list:length math:greaterThan ?j .
    ( ?all_sorted ?j ) list:memberAt ?event2 .

    # ?pr log:equalTo p2:purchase_requisition:0:pr_trigger_0 .
    # ?pr a p2:purchase_requisition .
    # # "PR" log:trace ?pr .
    # ?pr log:skolem ?trace .

    # [] tr:object ?pr ; tr:event ?e1 .

    # [] tr:object ?pr ; tr:object2 ?qo .
    # ?qo rdf:type p2:quotation .
    # [] tr:object ?qo ; tr:event ?e2 .

    # [] tr:object ?qo ; tr:object2 ?po .
    # ?po rdf:type p2:purchase_order .
    # [] tr:object ?po ; tr:event ?e3 .

    # [] tr:object ?po ; tr:object2 ?pa .
    # ?pa rdf:type p2:payment .
    # [] tr:object ?pa ; tr:event ?e4 .

    # [] tr:object2 ?pa ; tr:object ?ir .
    # ?ir rdf:type p2:invoice_receipt .
    # [] tr:object ?ir ; tr:event ?e5 .

} => {
    [ 
        tr:in ?trace ;
        tr:case_obj ?pr ;
        tr:from ?event ; 
        tr:to ?event2 ;
    ]

    # [] :waffles ?events_sorted

    # ?trace a tr:Trace ; 
    #     tr:case_obj_root p2:purchase_requisition ;
    #     tr:event ?e1 , ?e2 , ?e3 , ?e4 , ?e5
} .